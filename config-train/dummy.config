#!returnn/rnn.py
# kate: syntax python;

import os
from returnn.util.basic import get_login_username
demo_name, _ = os.path.splitext(__file__)
print("Hello, experiment: %s" % demo_name)

# task
use_tensorflow = True
task = "train"
"""
Global Parameters Required:
    task, _target_num_labels, _targetb_num_labels, _targetb_blank_idx, _target, beam_size, model
Global Functions Required:
    rna_loss(), targetb_recomb_recog(), switchout_target(), out_str(), rna_fullsum_alignment()
"""
def get_dataset():
  return {"class": "TaskXmlModelingDataset", "num_seqs": 1000}


train = {"class": "TaskXmlModelingDataset", "num_seqs": 1000}


dev = train.copy()
dev.update({"num_seqs": train["num_seqs"] // 10, "fixed_random_seed": 42})


# network
# (also defined by num_inputs & num_outputs)
network = {
  "lstm0_fw": {"class": "rec", "unit": "lstmp", "n_out" : 20, "dropout": 0.0, "L2": 0.01, "direction": 1},
  "lstm0_bw": {"class": "rec", "unit": "lstmp", "n_out" : 20, "dropout": 0.0, "L2": 0.01, "direction": -1},

  "lstm1_fw": {"class": "rec", "unit": "lstmp", "n_out" : 20, "dropout": 0.0, "L2": 0.01, "direction": 1, "from" : ["lstm0_fw", "lstm0_bw"] },
  "lstm1_bw": {"class": "rec", "unit": "lstmp", "n_out" : 20, "dropout": 0.0, "L2": 0.01, "direction": -1, "from" : ["lstm0_fw", "lstm0_bw"] },

  "encoder": {"class": "linear", "activation": "tanh", "from": ["lstm1_fw", "lstm1_bw"], "n_out": 20},
  "enc_ctx": {"class": "linear", "activation": "tanh", "from": ["encoder"], "n_out": 20},

  "output": {"class": "rec", "from": [], "unit": {
      # Like Bahdanau et al / Montreal NMT:
      'orth_embed': {'class': 'linear', 'activation': None, 'from': ['data:classes'], "n_out": 10},
      "s": {"class": "rnn_cell", "unit": "LSTMBlock", "from": ["prev:c", "prev:orth_embed"], "n_out": 20},
      "c_in": {"class": "linear", "activation": "tanh", "from": ["s", "prev:orth_embed"], "n_out": 20},
      "c": {"class": "dot_attention", "from": ["c_in"], "base": "base:encoder", "base_ctx": "base:enc_ctx", "n_out": 20},
      "output": {"class": "softmax", "from": ["prev:s", "c"], "target": "classes"}
}, "target": "classes", "loss": "ce"}

}


extern_data = {
            "data": {"dim": 12, 'shape': (None, 12)},  # Gammatone 40-dim
            "classes": {"dim": 12, 'shape': (None, ), "sparse": True},  # see vocab
        }

# batching
batching = "random"
batch_size = 5000
max_seqs = 40
max_seq_length = 100

# trainer
chunking = "0"
truncation = -1
#gradient_clip = 10
gradient_nan_inf_filter = True
adam = True
gradient_noise = 0.3
learning_rate = 0.0005
learning_rate_control = "newbob"
learning_rate_control_relative_error_relative_lr = True
model = "/tmp/%s/returnn/%s/model" % (get_login_username(), demo_name)  # https://github.com/tensorflow/tensorflow/issues/6537
num_epochs = 100
save_interval = 1

# log
log_verbosity = 5

